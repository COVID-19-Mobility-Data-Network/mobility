<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitting and simulating a mobility model • mobility</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fitting and simulating a mobility model">
<meta property="og:description" content="mobility">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-173221313-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-173221313-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mobility</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.6.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/V1_data_template.html">A generalized format for longform travel data</a>
    </li>
    <li>
      <a href="../articles/V2_build_matrices.html">Building matrices from longform travel data</a>
    </li>
    <li>
      <a href="../articles/V3_fitting_mobility_models.html">Fitting and simulating a mobility model</a>
    </li>
    <li>
      <a href="../articles/V4_fitting_prob_travel.html">Fitting and simulating travel probability</a>
    </li>
    <li>
      <a href="../articles/V5_list_models.html">A curated list of mobility models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/COVID-19-Mobility-Data-Network/mobility/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="V3_fitting_mobility_models_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Fitting and simulating a mobility model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/COVID-19-Mobility-Data-Network/mobility/blob/master/vignettes/V3_fitting_mobility_models.Rmd"><code>vignettes/V3_fitting_mobility_models.Rmd</code></a></small>
      <div class="hidden name"><code>V3_fitting_mobility_models.Rmd</code></div>

    </div>

    
    
<p>One of the most commonly used types of mobility model is the gravity model, which is used to model connectivity among locations based on the distances among <span class="math inline">\(i\)</span> origins and <span class="math inline">\(j\)</span> destinations (<span class="math inline">\(d_{ij}\)</span>) and population sizes of each location (<span class="math inline">\(N_i\)</span> and <span class="math inline">\(N_j\)</span>). A major advantage of the gravity model is that distance and population size are simple covariates that can be obtained in almost any context, allowing a researcher to infer connectivity with little information.</p>
<p>When fitting the gravity model to data, we also need a matrix of observed travel volume (<span class="math inline">\(M\)</span>). Travel volume is an intentionally vague term here because a mobility data matrix can be populated with a variety of measurements that capture relative amounts of travel among locations. For example, if we are using Call Data Records (CDR) which are measures of mobile phone usage supplied by mobile phone companies, the unit of travel volume is likely to be the total number of person trips per unit time. Or if we are using a travel survey that researchers have collated from questionares given to residents of an area, the measurement of travel volume might be the total number of individuals that reported travelling from <span class="math inline">\(i\)</span> to <span class="math inline">\(j\)</span> in the past month. It is important that all <span class="math inline">\(ij\)</span> cells in <span class="math inline">\(M\)</span> have the same unit of travel volume per unit time because the model estimates parameters based on relative differences in travel volume.</p>
<p>The rest of this vignette shows a simple example of how to use the workhorse functions in this package (<code><a href="../reference/mobility.html">mobility()</a></code>, <code><a href="../reference/predict.html">predict()</a></code>, and <code><a href="../reference/check.html">check()</a></code>) to estimate travel volume (<span class="math inline">\(\hat{M}_{ij}\)</span>) for all <span class="math inline">\(i \rightarrow j\)</span> travel routes found in the supplied data matrices (<span class="math inline">\(M\)</span>, <span class="math inline">\(D\)</span>, and <span class="math inline">\(N\)</span>). Travel volume can also be predicted for a different geographic region or data on a different spatial scale by supplying these other data to the <code>newdata</code> argument of the <code><a href="../reference/predict.html">predict()</a></code> function.</p>
<div id="build-data-matrices" class="section level2">
<h2 class="hasAnchor">
<a href="#build-data-matrices" class="anchor"></a>Build data matrices</h2>
<p>Before we can fit a mobility model, we must build data matrices from the longform travel data. The utility functions <code><a href="../reference/get_mob_matrix.html">get_mob_matrix()</a></code>, <code><a href="../reference/get_distance_matrix.html">get_distance_matrix()</a></code>, and <code><a href="../reference/get_pop_vec.html">get_pop_vec()</a></code> can be used to generate data matrices representing travel volume among locations (<span class="math inline">\(M\)</span>), along with distances (<span class="math inline">\(D\)</span>) and population sizes (<span class="math inline">\(N\)</span>). The <code>mobiliy_matrices()</code> data object included with this package provides a list of simulated data matrices and is formatted for the <code>data</code> argument of the <code><a href="../reference/mobility.html">mobility()</a></code> function, which requires a list of numerical matrices/vectors with matching dimensions and names.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="fu">mobility</span><span class="fu">::</span><span class="va"><a href="../reference/mobility_matrices.html">mobility_matrices</a></span><span class="op">)</span>
<span class="co">#&gt; List of 3</span>
<span class="co">#&gt;  $ M: num [1:10, 1:10] 4559 NA 25 1964 NA ...</span>
<span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">#&gt;   .. ..$ origin     : chr [1:10] "A" "B" "C" "D" ...</span>
<span class="co">#&gt;   .. ..$ destination: chr [1:10] "A" "B" "C" "D" ...</span>
<span class="co">#&gt;  $ D: num [1:10, 1:10] 0 671 1023 521 796 ...</span>
<span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">#&gt;   .. ..$ origin     : chr [1:10] "A" "B" "C" "D" ...</span>
<span class="co">#&gt;   .. ..$ destination: chr [1:10] "A" "B" "C" "D" ...</span>
<span class="co">#&gt;  $ N: Named num [1:10] 9868 9511 5561 9596 12741 ...</span>
<span class="co">#&gt;   ..- attr(*, "names")= chr [1:10] "A" "B" "C" "D" ...</span></code></pre></div>
<p>By design, we have added additional stochasticity around trip counts in the movement matrix (<span class="math inline">\(M\)</span>) and randomly sampled 80% of observed routes to simulate missing observations, which are shown as grey cells in the plot below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu">melt</span><span class="op">(</span><span class="va">mobility_matrices</span><span class="op">$</span><span class="va">M</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">destination</span><span class="op">)</span>,
                y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">origin</span><span class="op">)</span>,
                fill<span class="op">=</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">'Destination'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Origin"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,
                     axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,
                     axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span>,
                     axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>r <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span>,
                     legend.position<span class="op">=</span><span class="st">'bottom'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">viridis</span><span class="fu">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html">scale_fill_viridis</a></span><span class="op">(</span>option<span class="op">=</span><span class="st">'inferno'</span>, direction<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html">guide_colorbar</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">'Observed number of trips'</span>,
                             title.position<span class="op">=</span><span class="st">'top'</span>,
                             label.theme<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span>,
                             barwidth<span class="op">=</span><span class="fl">20</span>,
                             barheight<span class="op">=</span><span class="fl">0.5</span>,
                             frame.colour<span class="op">=</span><span class="st">'black'</span>,
                             ticks<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="V3_fitting_mobility_models_files/figure-html/data_plot-1.png" width="624"></p>
</div>
<div id="fit-a-mobility-model-to-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-a-mobility-model-to-the-data" class="anchor"></a>Fit a mobility model to the data</h2>
<p>Several different mobility models can be fitted to the data using the <code><a href="../reference/mobility.html">mobility()</a></code> function. For a full list of available models, see the ‘Curated list of mobility models’ vignette. This function uses the distance among locations (<span class="math inline">\(D\)</span>) and population sizes (<span class="math inline">\(N\)</span>) as covariates in the specified model equation, which is fitted to the movement matrix (<span class="math inline">\(M\)</span>) with a Poisson likelihood link function. Fitting a gravity model can be specified using the <code>model = 'gravity'</code> argument. The <code><a href="../reference/mobility.html">mobility()</a></code> function contains several variants of the gravity model which can be specified by the <code>type</code> argument.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mobility.html">mobility</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mobility_matrices</span>,
                model<span class="op">=</span><span class="st">'gravity'</span>,
                type<span class="op">=</span><span class="st">'power_norm'</span>,
                n_chain<span class="op">=</span><span class="fl">2</span>,
                n_burn<span class="op">=</span><span class="fl">1000</span>,
                n_samp<span class="op">=</span><span class="fl">1000</span>,
                n_thin<span class="op">=</span><span class="fl">2</span>,
                DIC<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; ::Fitting power_norm gravity model for 10 origins and 10 destinations::</span>
<span class="co">#&gt; Compiling model graph</span>
<span class="co">#&gt;    Resolving undeclared variables</span>
<span class="co">#&gt;    Allocating nodes</span>
<span class="co">#&gt; Graph information:</span>
<span class="co">#&gt;    Observed stochastic nodes: 70</span>
<span class="co">#&gt;    Unobserved stochastic nodes: 33</span>
<span class="co">#&gt;    Total graph size: 648</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Initializing model</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; NOTE: Stopping adaptation</span></code></pre></div>
<p>In this example, specifying <code>type = 'power_norm'</code> will fit a normalized gravity model, which uses a power law dispersal kernel and normalizes the connectivity of all routes emanating from origin <span class="math inline">\(i\)</span>: <span class="math display">\[
\begin{aligned}
        m_{ij} &amp;\sim \text{Poisson}\big(\lambda_{ij}\big)\\
        \\
        \lambda_{ij} &amp;= \theta N_i \Bigg(
        \frac{
        N_j^\omega d_{ij}^{-\gamma}
        }{
        \sum_{\forall j} N_j^\omega d_{ij}^{-\gamma}
        } \Bigg)
\end{aligned}   
\]</span> Here, <span class="math inline">\(\theta\)</span> is a proportionality constant representing the overall number of trips per person taken from the origin population <span class="math inline">\(N_i\)</span>, and the exponential parameter <span class="math inline">\(\omega\)</span> scales the attractive force of each <span class="math inline">\(j\)</span> destination population sizes. The kernel function <span class="math inline">\(d_{ij}^{-\gamma}\)</span> serves as a penalty on the proportion of travel from <span class="math inline">\(i\)</span> to <span class="math inline">\(j\)</span> based on distance. The function estimates the posterior distribution of these model parameters using a Poisson likelihood and Bayesian MCMC inference. The additional arguments determine the parameters for the MCMC algorithm. Here, the function will use 2 sampling chains, discards the first 1000 samples as ‘burin in’, and then take 1000 samples thinning by 2 to give 500 total samples per chain. The <code>DIC=TRUE</code> argument tells the function to calculate the Deviance Information Criterion (DIC) of the fitted model.</p>
<p>Fitting a mobility model to a large number of locations (e.g. <span class="math inline">\(\gt 100\)</span>) or drawing a large number of samples from posterior distributions (e.g. 10000) may take several minutes. If computation is cumbersome, then the model can run sampling chains in parallel instead of sequentially by specifying <code>parallel = TRUE</code>.</p>
<p>The fitting function <code><a href="../reference/mobility.html">mobility()</a></code> returns results as a <code>mobility.model</code> that contains information on the type of model, the data used, and the estimated model parameters.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>
<span class="co">#&gt; List of 10</span>
<span class="co">#&gt;  $ model  : chr "gravity"</span>
<span class="co">#&gt;  $ type   : chr "power_norm"</span>
<span class="co">#&gt;  $ n_chain: num 2</span>
<span class="co">#&gt;  $ n_burn : num 1000</span>
<span class="co">#&gt;  $ n_samp : num 1000</span>
<span class="co">#&gt;  $ n_thin : num 2</span>
<span class="co">#&gt;  $ DIC    : logi TRUE</span>
<span class="co">#&gt;  $ data   :List of 4</span>
<span class="co">#&gt;   ..$ M     : num [1:10, 1:10] 4559 NA 25 1964 NA ...</span>
<span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 2</span>
<span class="co">#&gt;   .. .. ..$ origin     : chr [1:10] "A" "B" "C" "D" ...</span>
<span class="co">#&gt;   .. .. ..$ destination: chr [1:10] "A" "B" "C" "D" ...</span>
<span class="co">#&gt;   ..$ D     : num [1:10, 1:10] 0 671 1023 521 796 ...</span>
<span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 2</span>
<span class="co">#&gt;   .. .. ..$ origin     : chr [1:10] "A" "B" "C" "D" ...</span>
<span class="co">#&gt;   .. .. ..$ destination: chr [1:10] "A" "B" "C" "D" ...</span>
<span class="co">#&gt;   ..$ N_orig: Named num [1:10] 9868 9511 5561 9596 12741 ...</span>
<span class="co">#&gt;   .. ..- attr(*, "names")= chr [1:10] "A" "B" "C" "D" ...</span>
<span class="co">#&gt;   ..$ N_dest: Named num [1:10] 9868 9511 5561 9596 12741 ...</span>
<span class="co">#&gt;   .. ..- attr(*, "names")= chr [1:10] "A" "B" "C" "D" ...</span>
<span class="co">#&gt;  $ params :List of 2</span>
<span class="co">#&gt;   ..$ : 'mcmc' num [1:500, 1:6] 44243 44242 44245 44244 44242 ...</span>
<span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 2</span>
<span class="co">#&gt;   .. .. ..$ : NULL</span>
<span class="co">#&gt;   .. .. ..$ : chr [1:6] "deviance" "gamma" "omega" "pD" ...</span>
<span class="co">#&gt;   .. ..- attr(*, "mcpar")= num [1:3] 1 500 1</span>
<span class="co">#&gt;   ..$ : 'mcmc' num [1:500, 1:6] 44246 44244 44245 44245 44247 ...</span>
<span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 2</span>
<span class="co">#&gt;   .. .. ..$ : NULL</span>
<span class="co">#&gt;   .. .. ..$ : chr [1:6] "deviance" "gamma" "omega" "pD" ...</span>
<span class="co">#&gt;   .. ..- attr(*, "mcpar")= num [1:3] 1 500 1</span>
<span class="co">#&gt;   ..- attr(*, "class")= chr "mcmc.list"</span>
<span class="co">#&gt;  $ summary:'data.frame': 6 obs. of  8 variables:</span>
<span class="co">#&gt;   ..$ mean : num [1:6] 1.95e-01 5.48e-04 9.96e-01 4.42e+04 4.42e+04 ...</span>
<span class="co">#&gt;   ..$ sd   : num [1:6] 0.000623 0.000545 0.004043 2.903769 2.903769 ...</span>
<span class="co">#&gt;   ..$ Q2.5 : num [1:6] 1.94e-01 1.38e-05 9.87e-01 4.42e+04 4.42e+04 ...</span>
<span class="co">#&gt;   ..$ Q97.5: num [1:6] 1.96e-01 2.07e-03 1.00 4.43e+04 4.43e+04 ...</span>
<span class="co">#&gt;   ..$ Rhat : num [1:6] 1 1.03 1 1.04 1.04 NA</span>
<span class="co">#&gt;   ..$ n.eff: num [1:6] 690 348 908 503 503 NA</span>
<span class="co">#&gt;   ..$ AC5  : num [1:6] -0.05 0.06 0.03 0.04 0.04 NA</span>
<span class="co">#&gt;   ..$ AC10 : num [1:6] 0.02 0.01 -0.05 0.04 0.04 NA</span>
<span class="co">#&gt;  - attr(*, "class")= chr "mobility.model"</span></code></pre></div>
</div>
<div id="model-summary-and-validation" class="section level2">
<h2 class="hasAnchor">
<a href="#model-summary-and-validation" class="anchor"></a>Model summary and validation</h2>
<p>To calculate summary statistics of estimated parameter values, you can supply a fitted <code>mobility.model</code> object to the <code><a href="../reference/summary.html">summary()</a></code> function. This function is a wrapper for the <code><a href="https://rdrr.io/pkg/MCMCvis/man/MCMCsummary.html">MCMCvis::MCMCsummary()</a></code> function that calculates summary statistics for each parameter across each chain along with convergance diagnosics like the Gelman-Rubin convergence diagnostic and (<span class="math inline">\(\hat{R}\)</span>) and samples auto-correlation foreach parameter.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/summary.html">summary</a></span><span class="op">(</span><span class="va">mod</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span>, ac_lags<span class="op">=</span><span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt;                  mean           sd         Q2.5        Q97.5 Rhat n.eff  AC10</span>
<span class="co">#&gt; gamma    1.951544e-01 0.0006230930 1.939687e-01 1.964089e-01 1.00   690  0.02</span>
<span class="co">#&gt; omega    5.476347e-04 0.0005451965 1.376488e-05 2.071149e-03 1.03   348  0.01</span>
<span class="co">#&gt; theta    9.955340e-01 0.0040434887 9.871170e-01 1.003379e+00 1.00   908 -0.05</span>
<span class="co">#&gt; DIC      4.424905e+04 2.9037686378 4.424541e+04 4.425686e+04 1.04   503  0.04</span>
<span class="co">#&gt; deviance 4.424498e+04 2.9037686378 4.424134e+04 4.425279e+04 1.04   503  0.04</span>
<span class="co">#&gt; pD       2.034026e+00           NA           NA           NA   NA    NA    NA</span></code></pre></div>
<p>The <code><a href="../reference/check.html">check()</a></code> function provides goodness of fit metrics and summary plots for the fitted model.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/check.html">check</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></code></pre></div>
<p><img src="V3_fitting_mobility_models_files/figure-html/check-1.png" width="720"></p>
<pre><code>#&gt; $DIC
#&gt; [1] 44249.05
#&gt; 
#&gt; $RMSE
#&gt; [1] 1046.447
#&gt; 
#&gt; $MAPE
#&gt; [1] 5.581322
#&gt; 
#&gt; $R2
#&gt; [1] 0.7122143</code></pre>
</div>
<div id="simulating-a-fitted-mobility-model" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-a-fitted-mobility-model" class="anchor"></a>Simulating a fitted mobility model</h2>
<p>Once we have verified that our model fits the data adequately, we can simulate connectivity values among locations in our data using the estimated parameter values in the <code>'mobility.model'</code> object using the <code><a href="../reference/predict.html">predict()</a></code> function.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">M_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict.html">predict</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, <span class="fl">4000</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu">melt</span><span class="op">(</span><span class="va">M_hat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">destination</span><span class="op">)</span>,
                y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">origin</span><span class="op">)</span>,
                fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">'Destination'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Origin"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,
                     axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,
                     axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span>,
                     axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>r <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span>,
                     legend.position<span class="op">=</span><span class="st">'bottom'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">viridis</span><span class="fu">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html">scale_fill_viridis</a></span><span class="op">(</span>option<span class="op">=</span><span class="st">'inferno'</span>, 
                              direction<span class="op">=</span><span class="fl">1</span>,
                              breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">breaks</span><span class="op">)</span>,
                              labels<span class="op">=</span><span class="va">breaks</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html">guide_colorbar</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">'Estimated number of trips'</span>,
                             title.position<span class="op">=</span><span class="st">'top'</span>,
                             label.theme<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span>,
                             barwidth<span class="op">=</span><span class="fl">20</span>,
                             barheight<span class="op">=</span><span class="fl">0.5</span>,
                             frame.colour<span class="op">=</span><span class="st">'black'</span>,
                             ticks<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="V3_fitting_mobility_models_files/figure-html/sim_plot-1.png" width="624"></p>
</div>
<div id="predicting-a-fitted-mobility-model-onto-new-data" class="section level2">
<h2 class="hasAnchor">
<a href="#predicting-a-fitted-mobility-model-onto-new-data" class="anchor"></a>Predicting a fitted mobility model onto new data</h2>
<p>As shown above, the <code><a href="../reference/predict.html">predict()</a></code> function can be used to simulate the volume of travel among locations in the input data, and to infer travel for routes that are originally unobserved. If a new data set is supplied using the <code>'newdata'</code> argument, then the <code><a href="../reference/predict.html">predict()</a></code> function will predict travel volume given the new distance matrix (<span class="math inline">\(D\)</span>) and population size vector (<span class="math inline">\(N\)</span>) based on the fitted <code>mobility.model</code> object, allowing the fitted model to be projected onto data of a different geographic scale.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Simulate some new data</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">20</span>
<span class="va">ids</span> <span class="op">&lt;-</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>

<span class="co"># Distance matrix</span>
<span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_distance_matrix.html">get_distance_matrix</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="op">-</span><span class="fl">100</span>, <span class="fl">2</span><span class="op">)</span>,
                         y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">20</span>, <span class="fl">1</span><span class="op">)</span>,
                         id<span class="op">=</span><span class="va">ids</span><span class="op">)</span><span class="op">*</span><span class="fl">111.35</span>

<span class="co"># Vector of population sizes</span>
<span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html">rnbinom</a></span><span class="op">(</span><span class="va">n</span>, size<span class="op">=</span><span class="fl">5</span>, mu<span class="op">=</span><span class="fl">5000</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">ids</span>

<span class="co"># Predict mobility model using new data</span>
<span class="va">M_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict.html">predict</a></span><span class="op">(</span>object<span class="op">=</span><span class="va">mod</span>, newdata<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>D<span class="op">=</span><span class="va">D</span>, N<span class="op">=</span><span class="va">N</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, <span class="fl">4000</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu">melt</span><span class="op">(</span><span class="va">M_hat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">destination</span><span class="op">)</span>,
                y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">origin</span><span class="op">)</span>,
                fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">'Destination'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Origin"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,
                     axis.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,
                     axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span>,
                     axis.title.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>r <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span>,
                     legend.position<span class="op">=</span><span class="st">'bottom'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">viridis</span><span class="fu">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html">scale_fill_viridis</a></span><span class="op">(</span>option<span class="op">=</span><span class="st">'inferno'</span>, 
                              direction<span class="op">=</span><span class="fl">1</span>,
                              breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">breaks</span><span class="op">)</span>,
                              labels<span class="op">=</span><span class="va">breaks</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html">guide_colorbar</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">'Estimated number of trips'</span>,
                             title.position<span class="op">=</span><span class="st">'top'</span>,
                             label.theme<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span>,
                             barwidth<span class="op">=</span><span class="fl">20</span>,
                             barheight<span class="op">=</span><span class="fl">0.5</span>,
                             frame.colour<span class="op">=</span><span class="st">'black'</span>,
                             ticks<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="V3_fitting_mobility_models_files/figure-html/pred_plot-1.png" width="624"></p>
</div>
<div id="stochastic-simulation-of-a-mobility-model" class="section level2">
<h2 class="hasAnchor">
<a href="#stochastic-simulation-of-a-mobility-model" class="anchor"></a>Stochastic simulation of a mobility model</h2>
<p>As the default, the number of simulations is set to <code>nsim = 1</code> so that the <code><a href="../reference/predict.html">predict()</a></code> function simulates the mean point estimate of the provided mobility model using the mean of the posterior distribution of each estimated parameter. When <code>nsim &gt; 1</code>, the function performs stochastic simulation of the given model using the mean and standard deviation of the posterior parameter distributions. The <code>seed</code> argument can also be defined for reproducible simulation results.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">M_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict.html">predict</a></span><span class="op">(</span><span class="va">mod</span>, nsim<span class="op">=</span><span class="fl">5</span>, seed<span class="op">=</span><span class="fl">123</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">M_hat</span><span class="op">)</span>
<span class="co">#&gt;  num [1:10, 1:10, 1:5] 5818 407 226 456 535 ...</span>
<span class="co">#&gt;  - attr(*, "dimnames")=List of 3</span>
<span class="co">#&gt;   ..$ : chr [1:10] "A" "B" "C" "D" ...</span>
<span class="co">#&gt;   ..$ : chr [1:10] "A" "B" "C" "D" ...</span>
<span class="co">#&gt;   ..$ : NULL</span>
<span class="co">#&gt;  - attr(*, "model")= chr "gravity"</span>
<span class="co">#&gt;  - attr(*, "type")= chr "power_norm"</span>
<span class="co">#&gt;  - attr(*, "seed")= num 123</span>
<span class="co">#&gt;   ..- attr(*, "kind")=List of 3</span>
<span class="co">#&gt;   .. ..$ : chr "Mersenne-Twister"</span>
<span class="co">#&gt;   .. ..$ : chr "Inversion"</span>
<span class="co">#&gt;   .. ..$ : chr "Rejection"</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by John R Giles, Amy Wesolowski.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

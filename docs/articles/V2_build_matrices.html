<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Building matrices from longform travel data â€¢ mobility</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Building matrices from longform travel data">
<meta property="og:description" content="mobility">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-173221313-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-173221313-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mobility</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.6.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/V1_data_template.html">A generalized format for longform travel data</a>
    </li>
    <li>
      <a href="../articles/V2_build_matrices.html">Building matrices from longform travel data</a>
    </li>
    <li>
      <a href="../articles/V3_fitting_mobility_models.html">Fitting and simulating a mobility model</a>
    </li>
    <li>
      <a href="../articles/V4_fitting_prob_travel.html">Fitting and simulating travel probability</a>
    </li>
    <li>
      <a href="../articles/V5_list_models.html">A curated list of mobility models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/COVID-19-Mobility-Data-Network/mobility/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="V2_build_matrices_files/header-attrs-2.4/header-attrs.js"></script><script src="V2_build_matrices_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Building matrices from longform travel data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/COVID-19-Mobility-Data-Network/mobility/blob/master/vignettes/V2_build_matrices.Rmd"><code>vignettes/V2_build_matrices.Rmd</code></a></small>
      <div class="hidden name"><code>V2_build_matrices.Rmd</code></div>

    </div>

    
    
<p>Once the travel data has been converted the to generalized travel data format in the <code><a href="../reference/travel_data_template.html">travel_data_template()</a></code> and <code><a href="../reference/travel_data_sim.html">travel_data_sim()</a></code> objects, utility functions can be used to build the data matrices required for fitting and simulating mobility models. For fitting these models the data must be converted into data matrices representing travel among locations (<span class="math inline">\(M\)</span>), along with distances between locations (<span class="math inline">\(D\)</span>) and population sizes of the origins and destinations (<span class="math inline">\(N\)</span>).</p>
<div id="unique-ids" class="section level3">
<h3 class="hasAnchor">
<a href="#unique-ids" class="anchor"></a>Unique IDs</h3>
<p>The first step is to add unique IDs to the travel data. If the data have all unique names at the lowest admin level then hierarchical IDs are not needed. However, if the data include repeated admin names, then higher admin levels must be included to make unique IDs.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="va">travel_data</span> <span class="op">&lt;-</span> <span class="va">travel_data_sim</span>

<span class="co"># Add unique identifiers using Country, State, and County</span>
<span class="va">example_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_unique_ids.html">get_unique_ids</a></span><span class="op">(</span><span class="va">travel_data</span>, adm_start<span class="op">=</span><span class="fl">0</span>, adm_stop<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">example_ids</span><span class="op">)</span>
<span class="co">#&gt;   orig_id dest_id</span>
<span class="co">#&gt; 1   A_B_O   A_B_G</span>
<span class="co">#&gt; 2   A_B_S   A_B_U</span>
<span class="co">#&gt; 3   A_B_N   A_B_L</span>
<span class="co">#&gt; 4   A_B_C   A_B_O</span>
<span class="co">#&gt; 5   A_B_R   A_B_M</span>
<span class="co">#&gt; 6   A_B_V   A_B_G</span>

<span class="co"># Assume all County names here are unique, we can use only County level as ID.</span>
<span class="va">example_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_unique_ids.html">get_unique_ids</a></span><span class="op">(</span><span class="va">travel_data</span>, adm_start<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">example_ids</span><span class="op">)</span>
<span class="co">#&gt;   orig_id dest_id</span>
<span class="co">#&gt; 1       O       G</span>
<span class="co">#&gt; 2       S       U</span>
<span class="co">#&gt; 3       N       L</span>
<span class="co">#&gt; 4       C       O</span>
<span class="co">#&gt; 5       R       M</span>
<span class="co">#&gt; 6       V       G</span></pre></div>
</div>
<div id="build-mobility-matrix" class="section level3">
<h3 class="hasAnchor">
<a href="#build-mobility-matrix" class="anchor"></a>Build mobility matrix</h3>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co"># Add unique identifiers using County</span>
<span class="va">travel_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">travel_data</span>, <span class="fu"><a href="../reference/get_unique_ids.html">get_unique_ids</a></span><span class="op">(</span><span class="va">travel_data</span>, adm_start<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Build mobility matrix from the longform data</span>
<span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_mob_matrix.html">get_mob_matrix</a></span><span class="op">(</span>orig<span class="op">=</span><span class="va">travel_data</span><span class="op">$</span><span class="va">orig_id</span>,
                    dest<span class="op">=</span><span class="va">travel_data</span><span class="op">$</span><span class="va">dest_id</span>,
                    value<span class="op">=</span><span class="va">travel_data</span><span class="op">$</span><span class="va">trips</span><span class="op">)</span></pre></div>
<p><img src="V2_build_matrices_files/figure-html/plot%20M-1.png" width="672"></p>
<p>Many times there are missing observations in travel data. This is especially the case when the travel data span a short time period which increase the likelihood that travel along some routes will not be observed. It can be difficult to see these missing routes of travel in longform data, but when you make a matrix with each row <span class="math inline">\(i\)</span> representing and origin and each column <span class="math inline">\(j\)</span> representing a destination, the missing data are readily apparent (shown as grey cells in the simulated matrix above).</p>
</div>
<div id="build-distance-matrix" class="section level3">
<h3 class="hasAnchor">
<a href="#build-distance-matrix" class="anchor"></a>Build distance matrix</h3>
<p>Mobility models require that distances be provided for all routes even if these observations are missing in the mobility matrix (<span class="math inline">\(M\)</span>). A distance matrix for all unique routes can be built by getting all unique coordinates in the travel data using the <code><a href="../reference/get_unique_coords.html">get_unique_coords()</a></code> function and then calculating the distances among all locations with <code><a href="../reference/get_distance_matrix.html">get_distance_matrix()</a></code>. Note that there is no requirement for the units of the distance matrix. However, we recommend the scale used is sensible for the spatial scale of the study area.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">xy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_unique_coords.html">get_unique_coords</a></span><span class="op">(</span><span class="va">travel_data</span><span class="op">)</span>

<span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_distance_matrix.html">get_distance_matrix</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">xy</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,
                         y<span class="op">=</span><span class="va">xy</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,
                         id<span class="op">=</span><span class="va">xy</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>

<span class="va">D</span> <span class="op">&lt;-</span> <span class="va">D</span><span class="op">*</span><span class="fl">111.35</span> <span class="co"># decimal degrees to km</span>
<span class="va">D</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>
<span class="co">#&gt;       destination</span>
<span class="co">#&gt; origin        A         B         C        D         E</span>
<span class="co">#&gt;      A   0.0000 236.22609 151.06324 493.0824 139.02433</span>
<span class="co">#&gt;      B 236.2261   0.00000  85.84357 346.2563  99.05488</span>
<span class="co">#&gt;      C 151.0632  85.84357   0.00000 396.3398  26.41282</span>
<span class="co">#&gt;      D 493.0824 346.25626 396.33982   0.0000 385.29829</span>
<span class="co">#&gt;      E 139.0243  99.05488  26.41282 385.2983   0.00000</span></pre></div>
</div>
<div id="population-size-vector" class="section level3">
<h3 class="hasAnchor">
<a href="#population-size-vector" class="anchor"></a>Population size vector</h3>
<p>Fitting mobility modelsalso require a vector of population size for each location that is the same length the number of rows and columns in the mobility matrix (<span class="math inline">\(M\)</span>) and distance matrix (<span class="math inline">\(D\)</span>).</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_pop_vec.html">get_pop_vec</a></span><span class="op">(</span><span class="va">travel_data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
<span class="co">#&gt;    A    B    C    D    E    F </span>
<span class="co">#&gt; 5065 8179 3961 5540 1337 5776</span></pre></div>
<p>Note that since the distance matrix (<span class="math inline">\(N\)</span>) and population vector (<span class="math inline">\(N\)</span>) are covariates used by models, they cannot have missing values and must all have matching dimensions. Code below checks that all data dimensions match.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="co"># check</span>
<span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span>
     <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">identical</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
     <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span><span class="op">$</span><span class="va">origin</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">identical</span>, <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span><span class="op">$</span><span class="va">origin</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by John Giles, Amy Wesolowski.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

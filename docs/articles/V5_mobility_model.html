<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitting and simulating a full mobility model • mobility</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fitting and simulating a full mobility model">
<meta property="og:description" content="mobility">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mobility</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/V1_data_template.html">A generalized format for longform travel data</a>
    </li>
    <li>
      <a href="../articles/V2_build_matrices.html">Building matrices from longform travel data</a>
    </li>
    <li>
      <a href="../articles/V3_travel_probability.html">Fitting and simulating travel probability</a>
    </li>
    <li>
      <a href="../articles/V4_gravity_model.html">Fitting and simulating a gravity model</a>
    </li>
    <li>
      <a href="../articles/V5_mobility_model.html">Fitting and simulating a full mobility model</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/COVID-19-Mobility-Data-Network/mobility/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="V5_mobility_model_files/header-attrs-2.1/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Fitting and simulating a full mobility model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/COVID-19-Mobility-Data-Network/mobility/blob/master/vignettes/V5_mobility_model.Rmd"><code>vignettes/V5_mobility_model.Rmd</code></a></small>
      <div class="hidden name"><code>V5_mobility_model.Rmd</code></div>

    </div>

    
    
<p>So, what do we mean by “mobility” model? The mobility model estimated by this package is different from using just a gravity model in that it uses a flexible departure-diffusion model framework that estimates diagonal and off-diagonal elements of the mobility matrix (<span class="math inline">\(\hat{M}\)</span>) separately and combines both models using conditional probability rules. This is achieved by combining models that estimate: 1) the probabilty of travel outside the origin location <span class="math inline">\(i\)</span> (<span class="math inline">\(\tau_i\)</span>)—the departure process, and 2) the distribution of travel from the origin location <span class="math inline">\(i\)</span> to all <span class="math inline">\(j\)</span> destinations (<span class="math inline">\(\pi_{ij}\)</span>)—the diffusion process.</p>
<p>A common problem with mobility data, regardless of the source, is missing observations. This occurs when some <span class="math inline">\(i \rightarrow j\)</span> routes in the mobility data matrix were not observed during the time interval of data collection, or in the case of travel survey data, questions about travel may be collected for only a few locations. However, the role of a mobility matrix in other models (e.g. disease transmission models) is often to supply connectivity or travel volume for all possible routes of travel among locations. Therefore, the model fitting and simulation functions in this package are designed to help estimate <span class="math inline">\(\tau_i\)</span> and <span class="math inline">\(\pi_{ij}\)</span> for missing locations and allow extrapolation to other spatial scales.</p>
<p>The following vignette will use simulated data to give an example of how a full mobility model can be estimated and simulated from incomplete data. Both models described below can be fitted to data independently using the <code><a href="../reference/fit_prob_travel.html">fit_prob_travel()</a></code> and <code><a href="../reference/fit_gravity.html">fit_gravity()</a></code> functions. The <code><a href="../reference/fit_mobility.html">fit_mobility()</a></code> function is a wrapper that combines these models to estimate both diagonal and off-diagonal elements of the mobility matrix. The <code><a href="../reference/check_mobility.html">check_mobility()</a></code> and <code><a href="../reference/sim_mobility.html">sim_mobility()</a></code> functions then facilitate model validation and stochastic simulation of the fitted mobility model.</p>
<div id="build-data-matrices" class="section level2">
<h2 class="hasAnchor">
<a href="#build-data-matrices" class="anchor"></a>Build data matrices</h2>
<p>Before we can fit a mobility model, we must build data matrices from the longform travel data. When starting with this data form, the utility functions <code><a href="../reference/get_mob_matrix.html">get_mob_matrix()</a></code>, <code><a href="../reference/get_distance_matrix.html">get_distance_matrix()</a></code>, and <code><a href="../reference/get_pop_vec.html">get_pop_vec()</a></code> can be used to generate data matrices representing travel among locations (<span class="math inline">\(M\)</span>), along with distances (<span class="math inline">\(D\)</span>) and population sizes (<span class="math inline">\(N\)</span>). These data structures are used by the modeling and simulation functions. Here we use pre-built matrices from simulated data in the <code>mobiliy_matrices()</code> data object.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">M</span> <span class="kw">&lt;-</span> <span class="no">mobility_matrices</span>$<span class="no">M</span>
<span class="no">D</span> <span class="kw">&lt;-</span> <span class="no">mobility_matrices</span>$<span class="no">D</span>
<span class="no">N</span> <span class="kw">&lt;-</span> <span class="no">mobility_matrices</span>$<span class="no">N</span></pre></body></html></div>
<p>By design, we have added additional stochasticity around trip counts in the movement matrix (<span class="math inline">\(M\)</span>) and randomly sampled 70% of observed routes to simulate missing observations, which are shown as grey cells in the plot below.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu">ggplot</span>(<span class="kw">data</span><span class="kw">=</span><span class="fu">melt</span>(<span class="no">M</span>)) +
  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">destination</span>),
                <span class="kw">y</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">origin</span>),
                <span class="kw">fill</span><span class="kw">=</span><span class="no">value</span>)) +
  <span class="fu">xlab</span>(<span class="st">'Destination'</span>) + <span class="fu">ylab</span>(<span class="st">"Origin"</span>) +
  <span class="fu">theme_bw</span>() + <span class="fu">theme</span>(<span class="kw">axis.text.x</span><span class="kw">=</span><span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">10</span>),
                     <span class="kw">axis.text.y</span><span class="kw">=</span><span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">10</span>),
                     <span class="kw">axis.title.x</span><span class="kw">=</span><span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">12</span>, <span class="kw">margin</span> <span class="kw">=</span> <span class="fu">margin</span>(<span class="kw">t</span> <span class="kw">=</span> <span class="fl">15</span>)),
                     <span class="kw">axis.title.y</span><span class="kw">=</span><span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">12</span>, <span class="kw">margin</span> <span class="kw">=</span> <span class="fu">margin</span>(<span class="kw">r</span> <span class="kw">=</span> <span class="fl">15</span>)),
                     <span class="kw">legend.position</span><span class="kw">=</span><span class="st">'bottom'</span>) +
  <span class="kw pkg">viridis</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>(<span class="kw">option</span><span class="kw">=</span><span class="st">'inferno'</span>, <span class="kw">direction</span><span class="kw">=</span><span class="fl">1</span>) +
  <span class="fu">guides</span>(<span class="kw">fill</span><span class="kw">=</span><span class="fu">guide_colorbar</span>(<span class="kw">title</span><span class="kw">=</span><span class="st">'Observed trips'</span>,
                             <span class="kw">title.position</span><span class="kw">=</span><span class="st">'top'</span>,
                             <span class="kw">label.theme</span><span class="kw">=</span><span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">9</span>),
                             <span class="kw">barwidth</span><span class="kw">=</span><span class="fl">20</span>,
                             <span class="kw">barheight</span><span class="kw">=</span><span class="fl">0.5</span>,
                             <span class="kw">frame.colour</span><span class="kw">=</span><span class="st">'black'</span>,
                             <span class="kw">ticks</span><span class="kw">=</span><span class="fl">TRUE</span>))</pre></body></html></div>
<p><img src="V5_mobility_model_files/figure-html/data_plot-1.png" width="624"></p>
</div>
<div id="estimate-probability-of-travel-outside-each-origin-location" class="section level2">
<h2 class="hasAnchor">
<a href="#estimate-probability-of-travel-outside-each-origin-location" class="anchor"></a>Estimate probability of travel outside each origin location</h2>
<p>To estimate the probability of traveling outside the origin location <span class="math inline">\(i\)</span>, the <code><a href="../reference/fit_mobility.html">fit_mobility()</a></code> function uses a Beta-Binomial model with hierarchical structure to infer travel probability in unobserved locations. <span class="math display">\[
y_i \sim \text{Binom}(\tau_i, \sum_{j} M_{ij})
\]</span> The random variable <span class="math inline">\(y_i\)</span> is the observed number of trips that leave origin <span class="math inline">\(i\)</span> within the time interval. Binomial parameters <span class="math inline">\(\tau_i\)</span> and <span class="math inline">\(\sum_{j} M_{ij}\)</span> are the success probability and total number of observed trips originating from <span class="math inline">\(i\)</span> respectively. In the absence of a linear predictor containing covariates, the conjugate prior distribution for a Binomial likelihood is the Beta distribution (a random variable between 0 and 1). Therefore, success probabilities <span class="math inline">\(\tau_i\)</span> are assumed to be independent samples drawn from a Beta distributed prior with shape and rate parameters <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> <span class="citation">(Gelman et al. 2003)</span>. <span class="math display">\[
\begin{aligned}
\tau_i &amp;\sim \text{Beta}(\alpha, \beta) \\
\tau_\text{pop} &amp;\sim \text{Beta}(\bar{\alpha}, \bar{\beta})
\end{aligned}
\]</span> The hierarchical structure comes from estimating <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> as population-level hyper-priors for the origin-level probabilities <span class="math inline">\(\tau_i\)</span>, where <span class="math inline">\(\tau_\text{pop}\)</span> captures the overall population-level mean with a distribution denoted as <span class="math inline">\(\text{Beta}(\bar{\alpha}, \bar{\beta})\)</span>. <span class="math display">\[
\begin{aligned}
\alpha &amp;\sim \text{Gamma}(1,0.1) \\
\beta &amp;\sim \text{Gamma}(1,0.1)
\end{aligned}
\]</span></p>
<p>This structure allows origin locations to have probabilities <span class="math inline">\(\tau_i\)</span> which are driven by data in each location and all unobserved locations regress to the population mean <span class="math inline">\(\tau_\text{pop}\)</span>.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">total</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="no">M</span>, <span class="kw">na.rm</span><span class="kw">=</span><span class="fl">TRUE</span>)
<span class="no">prob_trav</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/summarize_mobility.html">summarize_mobility</a></span>(
  <span class="fu"><a href="../reference/fit_prob_travel.html">fit_prob_travel</a></span>(<span class="kw">travel</span><span class="kw">=</span><span class="no">total</span>-<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">M</span>), <span class="kw">total</span><span class="kw">=</span><span class="no">total</span>)
)
<span class="co">#&gt; These missing locations will inherit population mean:</span>
<span class="co">#&gt; C F I J</span>
<span class="co">#&gt; Compiling model graph</span>
<span class="co">#&gt;    Resolving undeclared variables</span>
<span class="co">#&gt;    Allocating nodes</span>
<span class="co">#&gt; Graph information:</span>
<span class="co">#&gt;    Observed stochastic nodes: 6</span>
<span class="co">#&gt;    Unobserved stochastic nodes: 9</span>
<span class="co">#&gt;    Total graph size: 26</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Initializing model</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; NOTE: Stopping adaptation</span></pre></body></html></div>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu">ggplot</span>(<span class="kw">data</span><span class="kw">=</span><span class="no">prob_trav</span>) +
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">Mean</span>, <span class="kw">y</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">prob_trav</span>)), <span class="kw">size</span><span class="kw">=</span><span class="fl">2</span>) +
  <span class="kw pkg">ggstance</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggstance/man/geom_linerangeh.html">geom_linerangeh</a></span>(<span class="fu">aes</span>(<span class="kw">y</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">prob_trav</span>), <span class="kw">xmin</span><span class="kw">=</span><span class="no">HPD2.5</span>, <span class="kw">xmax</span><span class="kw">=</span><span class="no">HPD97.5</span>)) +
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">xlim</a></span>(<span class="fl">0</span>,<span class="fl">1</span>) +
  <span class="fu">xlab</span>(<span class="st">'Probability of travel outside origin'</span>) + <span class="fu">ylab</span>(<span class="st">'Origin'</span>) +
  <span class="fu">theme_bw</span>() + <span class="fu">theme</span>(<span class="kw">axis.text.x</span><span class="kw">=</span><span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">9</span>),
                     <span class="kw">axis.text.y</span><span class="kw">=</span><span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">9</span>),
                     <span class="kw">axis.title.x</span><span class="kw">=</span><span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">12</span>, <span class="kw">margin</span> <span class="kw">=</span> <span class="fu">margin</span>(<span class="kw">t</span> <span class="kw">=</span> <span class="fl">15</span>)),
                     <span class="kw">axis.title.y</span><span class="kw">=</span><span class="fu">element_text</span>(<span class="kw">size</span><span class="kw">=</span><span class="fl">12</span>, <span class="kw">margin</span> <span class="kw">=</span> <span class="fu">margin</span>(<span class="kw">r</span> <span class="kw">=</span> <span class="fl">15</span>)),
                     <span class="kw">legend.position</span><span class="kw">=</span><span class="st">'right'</span>)</pre></body></html></div>
<p><img src="V5_mobility_model_files/figure-html/unnamed-chunk-1-1.png" width="480"></p>
</div>
<div id="estimate-probability-of-travel-between-origins-and-destinations-using-gravity-model" class="section level2">
<h2 class="hasAnchor">
<a href="#estimate-probability-of-travel-between-origins-and-destinations-using-gravity-model" class="anchor"></a>Estimate probability of travel between origins and destinations using gravity model</h2>
<p>The <code><a href="../reference/fit_mobility.html">fit_mobility()</a></code> function estimates gravity model parameters using the distance among locations (<span class="math inline">\(D\)</span>) and population sizes (<span class="math inline">\(N\)</span>) as covariates in the gravity equation, which is fitted to the off-diagonal elements of the movement matrix (<span class="math inline">\(M\)</span>). The model formula uses a Poisson likelihood link function with the following specification: <span class="math display">\[
\begin{aligned}
        m_{ij} &amp;\sim \text{Poisson}\big(\pi_{ij}N_{i}\big)\\
        \pi_{ij} &amp;= c_{ij}/\sum_{\forall j}c_{ij} \\
        c_{ij} &amp;= \theta \Bigg(
        \frac{
        N_{i}^{\omega_1} N_{j}^{\omega_2}
        }{
        d_{ij}
        } \Bigg)
\end{aligned}   
\]</span> Gravity model parameters are fit through normalized connectivity values (<span class="math inline">\(\pi_{ij}\)</span>) that scale the Poission likelihood so that it is proportional to the observed trip counts along each <span class="math inline">\(i \rightarrow j\)</span> route (<span class="math inline">\(m_{ij}\)</span>). The exponential parameters <span class="math inline">\(\omega_1\)</span> and <span class="math inline">\(\omega_2\)</span> are weights that modify the contribution of origin and destination population sizes, and <span class="math inline">\(\theta\)</span> is a proportionality constant. The denominator of the gravity model, <span class="math inline">\(d_{ij}^\gamma\)</span>, serves as the dispersal kernel function. The fitting function estimates the posterior distribution of model parameters using Bayesian MCMC inference.</p>
</div>
<div id="combining-models-to-estimate-full-mobility-matrix" class="section level2">
<h2 class="hasAnchor">
<a href="#combining-models-to-estimate-full-mobility-matrix" class="anchor"></a>Combining models to estimate full mobility matrix</h2>
<p>The two models described above can now be combined into a departure-diffusion model to give the full mobility matrix <span class="math inline">\(\hat{M}\)</span>. Here, <span class="math inline">\(\tau_i\)</span> (the probability of leaving origin <span class="math inline">\(i\)</span>) is the departure process and <span class="math inline">\(\pi_{ij}\)</span> (the probability of going from <span class="math inline">\(i\)</span> to <span class="math inline">\(j\)</span>) is the diffusion process. The values of <span class="math inline">\(\pi_{ij}\)</span> sum to unity along each row, but the diagonal is missing, indicating that this is a relative quantity. That is to say, <span class="math inline">\(\pi_{ij}\)</span> gives the probability of going from <span class="math inline">\(i\)</span> to <span class="math inline">\(j\)</span> <strong>given</strong> that travel outside origin <span class="math inline">\(i\)</span> occurs. Therefore, we can use basic conditional probability rules <span class="citation">(Blitzstein and Hwang 2014)</span> to define the travel routes in the off-diagonals.</p>
<p><span class="math display">\[
\Pr( \text{depart}_i, \text{diffuse}_{i \rightarrow j}) = \Pr( \text{diffuse}_{i \rightarrow j} \mid \text{depart}_i ) \Pr(\text{depart}_i ) = \pi_{ij} \tau_i. 
\]</span> and <span class="math display">\[
\Pr( \neg \text{depart}_i ) =  1 - \tau_i.
\]</span></p>
<p>Now each row of the estimated mobility matrix <span class="math inline">\(\hat{M}\)</span> sum to 1 including the diagonal to give the absolute probability of travel <strong>within</strong> origins and <strong>among</strong> origins and destinations.</p>
</div>
<div id="fitting-a-mobility-model-to-data" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-a-mobility-model-to-data" class="anchor"></a>Fitting a mobility model to data</h2>
<p>The parameters <span class="math inline">\(\tau_i\)</span> and <span class="math inline">\(\pi_{ij}\)</span> can be estimated together using the <code><a href="../reference/fit_mobility.html">fit_mobility()</a></code> function:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">mod</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/summarize_mobility.html">summarize_mobility</a></span>(
  <span class="fu"><a href="../reference/fit_mobility.html">fit_mobility</a></span>(<span class="no">M</span>, <span class="no">D</span>, <span class="no">N</span>), <span class="kw">ac_lags</span><span class="kw">=</span><span class="fl">5</span>
)
<span class="co">#&gt; Estimating probability of travel outside origin...</span>
<span class="co">#&gt; These missing locations will inherit population mean:</span>
<span class="co">#&gt; C F I J</span>
<span class="co">#&gt; Compiling model graph</span>
<span class="co">#&gt;    Resolving undeclared variables</span>
<span class="co">#&gt;    Allocating nodes</span>
<span class="co">#&gt; Graph information:</span>
<span class="co">#&gt;    Observed stochastic nodes: 6</span>
<span class="co">#&gt;    Unobserved stochastic nodes: 9</span>
<span class="co">#&gt;    Total graph size: 26</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Initializing model</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; NOTE: Stopping adaptation</span>
<span class="co">#&gt; Complete.</span>
<span class="co">#&gt; Estimating travel among destinations with gravity model...</span>
<span class="co">#&gt; ::Fitting gravity model for 10 origins and 10 destinations::</span>
<span class="co">#&gt; Using uniformative priors</span>
<span class="co">#&gt; Compiling model graph</span>
<span class="co">#&gt;    Resolving undeclared variables</span>
<span class="co">#&gt;    Allocating nodes</span>
<span class="co">#&gt; Graph information:</span>
<span class="co">#&gt;    Observed stochastic nodes: 74</span>
<span class="co">#&gt;    Unobserved stochastic nodes: 30</span>
<span class="co">#&gt;    Total graph size: 1196</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Initializing model</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; NOTE: Stopping adaptation</span>
<span class="co">#&gt; Complete.</span>
<span class="no">mod</span>
<span class="co">#&gt;               Mean          SD      HPD2.5    HPD97.5 Rhat SSeff   AC5</span>
<span class="co">#&gt; gamma   1.72489487 0.012422712 1.698607800 1.74713269 1.00  1315  0.01</span>
<span class="co">#&gt; omega_1 1.39461262 0.703556865 0.441366719 2.73865108 1.02   402  0.20</span>
<span class="co">#&gt; omega_2 0.03084936 0.015540844 0.003483752 0.05982786 1.01  1089  0.00</span>
<span class="co">#&gt; theta   1.08416327 0.725169954 0.036684345 2.56151086 1.00   643  0.05</span>
<span class="co">#&gt; tau_1   0.53172858 0.005142319 0.522063084 0.54152979 1.01  1158 -0.03</span>
<span class="co">#&gt; tau_2   0.03894951 0.002012992 0.034969108 0.04294950 1.00  1134  0.03</span>
<span class="co">#&gt; tau_3   0.36100175 0.207675577 0.010456054 0.76128455 1.00  2125 -0.01</span>
<span class="co">#&gt; tau_4   0.70125172 0.005319987 0.690032741 0.71116931 1.00  1435 -0.01</span>
<span class="co">#&gt; tau_5   0.17758021 0.003770436 0.170570475 0.18539046 1.01   946  0.06</span>
<span class="co">#&gt; tau_6   0.36100175 0.207675577 0.010456054 0.76128455 1.00  2125 -0.01</span>
<span class="co">#&gt; tau_7   0.19128325 0.004063966 0.183517181 0.19923416 1.00  1363 -0.04</span>
<span class="co">#&gt; tau_8   0.65618771 0.004270642 0.647925288 0.66423713 1.00  1305  0.02</span>
<span class="co">#&gt; tau_9   0.36100175 0.207675577 0.010456054 0.76128455 1.00  2125 -0.01</span>
<span class="co">#&gt; tau_10  0.36100175 0.207675577 0.010456054 0.76128455 1.00  2125 -0.01</span></pre></body></html></div>
<p>The model output printed above tells us that 4 locations named C, D, F, and H were missing data and that these locations will inherit the population mean <span class="math inline">\(\tau_{\text{pop}}\)</span>. Other summary statistics tell us that, although the model converged for all parameters (<span class="math inline">\(\hat{R} \approx 1\)</span>) we could have run more samples for this example because effective sample sizes (<span class="math inline">\(SS_{\text{eff}}\)</span>) were low (<span class="math inline">\(\lt 1000\)</span>) for several parameters. We can improve effective sample sizes of increasing any of the <code>n_chain</code>, <code>n_burn</code>, <code>n_samp</code>, or <code>n_thin</code> arguments.</p>
</div>
<div id="checking-the-goodness-of-fit-of-a-mobility-model" class="section level2">
<h2 class="hasAnchor">
<a href="#checking-the-goodness-of-fit-of-a-mobility-model" class="anchor"></a>Checking the goodness of fit of a mobility model</h2>
<p>It is important to validate whether a fitted model is capturing trends in the supplied mobility data. The <code><a href="../reference/check_mobility.html">check_mobility()</a></code> function will calculate goodness of fit measures for a fitted model object.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="../reference/check_mobility.html">check_mobility</a></span>(<span class="kw">M</span><span class="kw">=</span><span class="no">M</span>,
               <span class="kw">D</span><span class="kw">=</span><span class="no">D</span>,
               <span class="kw">N</span><span class="kw">=</span><span class="no">N</span>,
               <span class="kw">mod</span><span class="kw">=</span><span class="no">mod</span>)</pre></body></html></div>
<p><img src="V5_mobility_model_files/figure-html/check%20mobility-1.png" width="672"></p>
<pre><code>#&gt; $RMSE
#&gt; [1] 300.9926
#&gt; 
#&gt; $MAPE
#&gt; [1] 1.116122
#&gt; 
#&gt; $R2
#&gt; [1] 0.9613171</code></pre>
<p>At first glance, our model seems to be doing a good job of capturing trends in the data. The posterior predictive check shows that if we just look at the overall distribution of trip counts in the mobility data matrix (<span class="math inline">\(M\)</span>), that the model has estimated trip counts (<span class="math inline">\(\hat{M}\)</span>) with about the same distribution. The Q-Q plot shows how the quantiles of the residuals of our model compare to the quantiles expected from a Normal distribution. We also see that the residuals are mostly Normally distributed with some deviation at the extremes.</p>
<p>The prediction error results compare actual trip count values in the data matrix <span class="math inline">\(M\)</span> with the predicted values of the estimated mobility model (<span class="math inline">\(\hat{M}\)</span>). These results indicate that our model has an average magnitude of error of about 300 trip counts (RMSE), which is on average about 1.1 times the observed trip count values. The R-squared value shows that our model captures approximately 96% of the variance observed in the supplied mobility data (a rather high value since we are fitting to simulated data).</p>
</div>
<div id="simulating-a-mobility-matrix-from-a-fitted-model" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-a-mobility-matrix-from-a-fitted-model" class="anchor"></a>Simulating a mobility matrix from a fitted model</h2>
<p>Now that we have a mobility model that fits provides sufficient fit to the data, we can now simulate values for the routes that are missing in the original data matrix <span class="math inline">\(M\)</span>. Values of <span class="math inline">\(\hat{M}\)</span> can then be simulated with the <code><a href="../reference/sim_mobility.html">sim_mobility()</a></code> function. The code below shows how to produce a simple point estimate prediction of <span class="math inline">\(\hat{M}\)</span> using mean parameter values from the fitted model.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">mod_sim</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/sim_mobility.html">sim_mobility</a></span>(<span class="no">D</span>,
                        <span class="no">N</span>,
                        <span class="kw">theta</span> <span class="kw">=</span> <span class="no">mod</span>[<span class="st">'theta'</span>,<span class="st">'Mean'</span>],
                        <span class="kw">omega_1</span> <span class="kw">=</span> <span class="no">mod</span>[<span class="st">'omega_1'</span>,<span class="st">'Mean'</span>],
                        <span class="kw">omega_2</span> <span class="kw">=</span> <span class="no">mod</span>[<span class="st">'omega_2'</span>,<span class="st">'Mean'</span>],
                        <span class="kw">gamma</span> <span class="kw">=</span> <span class="no">mod</span>[<span class="st">'gamma'</span>,<span class="st">'Mean'</span>],
                        <span class="kw">tau</span> <span class="kw">=</span> <span class="no">mod</span>[<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span>(<span class="st">'tau'</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">mod</span>)),<span class="st">'Mean'</span>])
<span class="no">mod_sim</span>[<span class="fl">1</span>:<span class="fl">5</span>,<span class="fl">1</span>:<span class="fl">5</span>]
<span class="co">#&gt;       destination</span>
<span class="co">#&gt; origin           A          B           C            D           E</span>
<span class="co">#&gt;      A 0.468271419 0.02970497 0.014131875 0.0459625585 0.022346460</span>
<span class="co">#&gt;      B 0.001809020 0.96105049 0.005136617 0.0006712854 0.003760515</span>
<span class="co">#&gt;      C 0.014100696 0.08415961 0.638998252 0.0069612798 0.051593342</span>
<span class="co">#&gt;      D 0.192223638 0.04609943 0.029177691 0.2987482774 0.042750967</span>
<span class="co">#&gt;      E 0.008548539 0.02362198 0.019780445 0.0039104480 0.822419792</span></pre></body></html></div>
<p>For applications where we want to simulate stochastic realizations of the mobility matrix based on the uncertainty in model parameters, such as in a spatial disease transmission model, we can give the <code><a href="../reference/sim_mobility.html">sim_mobility()</a></code> function the model object fitted by <code><a href="../reference/fit_mobility.html">fit_mobility()</a></code> and ask for <code>n</code> stochastic realizations. The following code will return a three-dimensional array where the third dimension contains the <code>n</code> simultions.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">mod_sim</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/sim_mobility.html">sim_mobility</a></span>(<span class="no">D</span>,
                        <span class="no">N</span>,
                        <span class="kw">mod</span><span class="kw">=</span><span class="no">mod</span>,
                        <span class="kw">n</span><span class="kw">=</span><span class="fl">3</span>)
<span class="no">mod_sim</span>[<span class="fl">1</span>:<span class="fl">5</span>,<span class="fl">1</span>:<span class="fl">5</span>,]
<span class="co">#&gt; , , 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;             A          B           C           D          E</span>
<span class="co">#&gt; A 0.469050219 0.02977768 0.014199396 0.045996410 0.02243364</span>
<span class="co">#&gt; B 0.001867315 0.95998202 0.005277002 0.000695605 0.00387164</span>
<span class="co">#&gt; C 0.020728510 0.12284537 0.472273184 0.010261476 0.07547932</span>
<span class="co">#&gt; D 0.193272216 0.04661026 0.029536369 0.292938548 0.04325172</span>
<span class="co">#&gt; E 0.008440559 0.02322949 0.019453655 0.003872838 0.82548656</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; , , 2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;             A          B           C            D           E</span>
<span class="co">#&gt; A 0.465393946 0.03002152 0.014210527 0.0463761985 0.022710365</span>
<span class="co">#&gt; B 0.001748588 0.96263021 0.004901549 0.0006512068 0.003638045</span>
<span class="co">#&gt; C 0.005463140 0.03235272 0.861131396 0.0027036754 0.019960619</span>
<span class="co">#&gt; D 0.190053663 0.04581896 0.028820630 0.3057774528 0.042691173</span>
<span class="co">#&gt; E 0.008513047 0.02341393 0.019462686 0.0039049721 0.824566769</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; , , 3</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;             A          B           C            D           E</span>
<span class="co">#&gt; A 0.465693291 0.03003103 0.014366876 0.0463366085 0.022622975</span>
<span class="co">#&gt; B 0.001660361 0.96449844 0.004687149 0.0006200755 0.003434006</span>
<span class="co">#&gt; C 0.014064323 0.08299137 0.643070715 0.0069751058 0.051014374</span>
<span class="co">#&gt; D 0.192054882 0.04648506 0.029532172 0.2958716574 0.043110307</span>
<span class="co">#&gt; E 0.008238028 0.02261738 0.018976215 0.0037875080 0.830047399</span></pre></body></html></div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references hanging-indent">
<div id="ref-blitzstein_introduction_2014">
<p>Blitzstein, Joseph, and Jessica Hwang. 2014. <em>Introduction to Probability, First Edition</em>. Chapman; Hall/CRC.</p>
</div>
<div id="ref-gelman_bayesian_2003">
<p>Gelman, Andrew, John Carlin, Hal Stern, and Donald Rubin. 2003. <em>Bayesian Data Analysis, Second Edition (Chapman &amp; Hall/CRC Texts in Statistical Science)</em>. Chapman; Hall/CRC.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by John Giles, Amy Wesolowski.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
